<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Rapport Financier - {{ mois_couvert_str }}</title>
    <link rel="stylesheet" href="/static/gestion/css/pdf_styles.css">
    <style>
        .header { text-align: center; margin-bottom: 30px; }
        .summary { border: 1px solid #333; padding: 15px; margin-bottom: 20px; page-break-inside: avoid; }
        .owner-section { margin-top: 30px; page-break-inside: avoid; }
    </style>
</head>
<body>
    <div class="header">
        {% if agence.logo %}
            <img src="{{ agence.logo.url }}" alt="Logo Agence" style="max-width: 150px; max-height: 80px; margin-bottom: 10px;">
        {% endif %}
        <h1>Rapport Financier Mensuel</h1>
        <h2>{{ mois_couvert_str }}</h2>
        <div class="agence-details" style="margin-bottom: 15px; border-top: 1px solid #eee; border-bottom: 1px solid #eee; padding: 10px 0;">
            <p style="margin: 0; font-weight: bold;">{{ agence.user.get_full_name }}</p>
            <p style="margin: 5px 0 0 0; font-size: 9px; color: #555; line-height: 1.4;">{{ agence.user.addresse|linebreaksbr }}<br>
            Tél: {{ agence.user.telephone }} | Email: {{ agence.user.email }}</p>
        </div>
        <p>Généré le {{ date_generation|date:"d F Y" }}</p>
        {% if proprietaire_filtre %}
            <p><strong>Rapport filtré pour le propriétaire : {{ proprietaire_filtre }}</strong></p>
        {% endif %}
    </div>

    <div class="summary">
        <h3>Résumé Global</h3>
        <table class="table">
            <tr>
                <th>Total Attendu</th>
                <td>{{ grand_total_attendu|floatformat:0 }} Frcfa</td>
            </tr>
            <tr>
                <th>Total Payé</th>
                <td>{{ grand_total_paye|floatformat:0 }} Frcfa</td>
            </tr>
            <tr>
                <th>Total Impayé</th>
                <td style="color: red;">{{ grand_total_impaye|floatformat:0 }} Frcfa</td>
            </tr>
            <tr>
                <th>Commission Totale Agence</th>
                <td>{{ grand_total_commission|floatformat:0 }} Frcfa</td>
            </tr>
        </table>
    </div>

    {% for detail in report_details %}
    <div class="owner-section">
        <h3>Détail pour : {{ detail.proprietaire }}</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Immeuble</th>
                    <th>Loyer Attendu</th>
                    <th>Loyer Payé</th>
                    <th>Impayé</th>
                </tr>
            </thead>
            <tbody>
                {% for immeuble_data in detail.immeubles_data %}
                <tr>
                    <td>{{ immeuble_data.immeuble.addresse|linebreaksbr }}</td>
                    <td>{{ immeuble_data.total_attendu|floatformat:0 }} Frcfa</td>
                    <td>{{ immeuble_data.total_paye|floatformat:0 }} Frcfa</td>
                    <td style="color: red;">{{ immeuble_data.total_impaye|floatformat:0 }} Frcfa</td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="font-weight: bold; background-color: #f2f2f2;">
                    <td colspan="3" style="text-align: right;">Commission Agence ({{ detail.proprietaire.taux_commission }}%)</td>
                    <td>{{ detail.commission|floatformat:0 }} Frcfa</td>
                </tr>
            </tfoot>
        </table>
    </div>
    {% endfor %}
</body>
</html>