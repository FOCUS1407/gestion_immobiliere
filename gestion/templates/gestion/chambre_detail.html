{% extends "gestion/base.html" %}

{% block title %}Détails de l'unité : {{ chambre.designation }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2">Unité : {{ chambre.designation }}</h1>
            <p class="text-muted">
                Immeuble : <a href="{% url 'gestion:immeuble_detail' chambre.immeuble.pk %}">{{ chambre.immeuble.addresse }}</a>
            </p>
        </div>
        <div>
            <a href="{% url 'gestion:immeuble_detail' chambre.immeuble.pk %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i>Retour à l'immeuble
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Informations sur le locataire -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Situation locative</h5>
                </div>
                <div class="card-body">
                    {% if chambre.locataire %}
                        <p><strong>Statut :</strong> <span class="badge bg-danger">Occupée</span></p>
                        <p><strong>Locataire :</strong> {{ chambre.locataire.prenom }} {{ chambre.locataire.nom }}</p>
                        {% if location_active %}
                            <p><strong>Date d'entrée :</strong> {{ location_active.date_entree|date:"d F Y" }}</p>
                        {% endif %}
                        {% if request.user.user_type == 'AG' %}
                            <form action="{% url 'gestion:liberer_chambre' chambre.pk %}" method="post" class="mt-3">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning">Libérer l'unité</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <p><strong>Statut :</strong> <span class="badge bg-success">Libre</span></p>
                        {% if location_form %}
                            <hr>
                            <h6 class="mb-3">Assigner un nouveau locataire</h6>
                            <form method="post" name="assign_tenant">
                                {% csrf_token %}
                                {{ location_form.as_p }}
                                <button type="submit" name="submit_location" class="btn btn-primary">Assigner le locataire</button>
                            </form>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Historique des paiements -->
            <div class="card shadow-sm mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Historique des Paiements</h5>
                    {% if request.user.user_type == 'AG' and chambre.locataire %}
                        <a href="{% url 'gestion:ajouter_paiement' chambre.pk %}" class="btn btn-success">
                            <i class="fas fa-plus me-2"></i>Enregistrer un paiement
                        </a>
                    {% endif %}
                </div>
                <div class="card-body p-0">
                    {% if payment_history %}
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Mois Couvert</th>
                                        <th>Statut</th>
                                        <th>Date de Paiement</th>
                                        <th>Montant</th>
                                        <th>Moyen</th>
                                        <th>Preuve</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in payment_history %}
                                    <tr>
                                        <td>{{ item.month }}</td>
                                        <td>
                                            {% if item.status == 'paid' %}
                                                <span class="badge bg-success">Payé</span>
                                            {% elif item.status == 'pending' %}
                                                <span class="badge bg-warning text-dark">En attente</span>
                                            {% else %}
                                                <span class="badge bg-danger">Impayé</span>
                                            {% endif %}
                                        </td>
                                        
                                        {% if item.payment %}
                                            <td>{{ item.payment.date_paiement|date:"d/m/Y" }}</td>
                                            <td>{{ item.payment.montant|floatformat:0 }} Frcfa</td>
                                            <td>{{ item.payment.moyen_paiement }}</td>
                                            <td>
                                                {% if item.payment.preuve_paiement %}
                                                    <a href="{{ item.payment.preuve_paiement.url }}" target="_blank" class="btn btn-sm btn-outline-secondary" title="Voir la preuve de paiement">
                                                      <i class="bi bi-file-earmark-text">Voir la preuve</i>
                                                    </a>
                                                {% else %}
                                                   -
                                                {% endif %}
                                            </td>
                                            <td class="text-end">
                                                {% if is_managing_agence %}
                                                   <a href="{% url 'gestion:modifier_paiement' item.payment.pk %}" class="btn btn-sm btn-outline-primary" title="Modifier">Modifier <i class="bi bi-pencil"></i></a>
                                                   <a href="{% url 'gestion:supprimer_paiement' item.payment.pk %}" class="btn btn-sm btn-outline-danger" title="Supprimer">Supprimer <i class="bi bi-trash"></i></a>
                                                   {% if item.payment.est_valide %}
                                                        <a href="{% url 'gestion:generer_quittance_pdf' item.payment.pk %}" class="btn btn-sm btn-outline-info" title="Générer la quittance" target="_blank">Générer la quittance <i class="bi bi-receipt"></i></a>
                                                   {% endif %}
                                                {% endif %}
                                            </td>
                                        {% else %}
                                            {# Cas pour les mois impayés #}
                                            <td colspan="4" class="text-muted text-center">---</td>
                                            <td class="text-end">
                                                {% if is_managing_agence %}
                                                    <a href="{% url 'gestion:ajouter_paiement' chambre.pk %}?mois={{ item.month|urlencode }}" class="btn btn-sm btn-success">Ajouter un paiement</a>
                                                {% endif %}
                                            </td>
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <p class="text-muted p-3">Aucun historique de paiement disponible pour cette location.</p>
                    {% endif %}
                </div>
            </div>

            <!-- État des Lieux Section -->
            {% if location_active %}
            <div class="card shadow-sm mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">États des Lieux</h4>
                </div>
                <div class="card-body">
                    <h5>Rapports existants</h5>
                    {% if etats_des_lieux %}
                        <ul class="list-group list-group-flush">
                            {% for etat in etats_des_lieux %}
                                <li class="list-group-item px-0">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <h6 class="mb-1">{{ etat.get_type_etat_display }}</h6>
                                            <p class="mb-1 text-muted small">Date: {{ etat.date_etat|date:"d F Y" }}</p>
                                            <p class="mb-0">{{ etat.description|linebreaksbr|truncatewords:30 }}</p>
                                        </div>
                                        <div class="text-end">
                                            {% if etat.document_signe %}
                                                <a href="{{ etat.document_signe.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="fas fa-file-alt me-1"></i> Voir le document
                                                </a>
                                            {% endif %}
                                            {% if request.user.user_type == 'AG' %}
                                                <a href="{% url 'gestion:modifier_etat_des_lieux' etat.pk %}" class="btn btn-sm btn-outline-secondary" title="Modifier"><i class="fas fa-edit"></i></a>
                                                <a href="{% url 'gestion:supprimer_etat_des_lieux' etat.pk %}" class="btn btn-sm btn-outline-danger" title="Supprimer"><i class="fas fa-trash"></i></a>
                                                <a href="{% url 'gestion:generer_etat_des_lieux_pdf' etat.pk %}" class="btn btn-sm btn-outline-info" title="Imprimer l'état des lieux" target="_blank"><i class="fas fa-print"></i></a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-muted">Aucun état des lieux n'a été enregistré pour cette location.</p>
                    {% endif %}

                    {% if request.user.user_type == 'AG' and etat_des_lieux_form %}
                        <hr class="my-4">
                        <h5>Ajouter un nouvel état des lieux</h5>
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            {{ etat_des_lieux_form.as_p }}
                            <button type="submit" name="submit_etat_des_lieux" class="btn btn-primary mt-2">Enregistrer le rapport</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
        <div class="col-lg-4">
            <!-- Informations sur l'unité -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0">Informations sur l'unité</h5>
                </div>
                <div class="card-body">
                    <p><strong>Loyer mensuel :</strong> {{ chambre.prix_loyer|floatformat:0 }} Frcfa</p>
                    <p><strong>Superficie :</strong> {{ chambre.superficie }} m²</p>
                    <p><strong>Mise en location le :</strong> {{ chambre.date_mise_en_location|date:"d F Y" }}</p>

                    {% if request.user.user_type == 'AG' %}
                    <hr>
                    <div class="mt-2">
                        <a href="{% url 'gestion:modifier_chambre' chambre.pk %}" class="btn btn-sm btn-primary"><i class="fas fa-edit me-2"></i>Modifier</a>
                        <a href="{% url 'gestion:supprimer_chambre' chambre.pk %}" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash me-2"></i>Supprimer</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}